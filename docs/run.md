# Run Service

Run:

    flask run

A local dev server will be created on (PORT specified in FLASK_RUN_PORT environment variable)

    http://localhost:{{PORT}}

Flask environment variables are configurable in `.flaskenv`

## Local Authentication
The assessment app protects different parts of functionality by interrogating the roles of the logged in user. In order to test this locally where we don't have SSO available, a debug user is available. This bypassess login and puts the required information in the session to allow you to appear logged in when running locally. To enable this:
* You must be running with `FLASK_ENV=development` (the default for `flask run` or the docker runner)
* Update [DevelopmentConfig](../config/envs/development.py) so that `DEBUG_USER_ON=True`
* Supply the desired role for the debug user using environment variable `DEBUG_USER_ROLE`. eg. `DEBUG_USER_ROLE=ASSESSOR`
* Run the app and navigate to /assess/assessor_dashboard/, you will see the logged in view and be able to comment, score, flag etc.
* When running locally with the debug user enabled, you will also see a yellow box in the top right hand corner of all pages to state which user you are using and their role.

### Run with Gunicorn

In deployed environments the service is run with gunicorn. You can run the service locally with gunicorn to test

First set the FLASK_ENV environment you wish to test eg:

    export FLASK_ENV=dev

Then run gunicorn using the following command:

    gunicorn wsgi:app -c run/gunicorn/local.py

### Build with Paketo

[Pack](https://buildpacks.io/docs/tools/pack/cli/pack_build/)

[Paketo buildpacks](https://paketo.io/)

```pack build <name your image> --builder paketobuildpacks/builder:base```

Example:

```
[~/work/repos/funding-service-design-assessment] pack build paketo-demofsd-app --builder paketobuildpacks/builder:base
***
Successfully built image paketo-demofsd-app
```

You can then use that image with docker to run a container

```
docker run -d -p 8080:8080 --env PORT=8080 --env FLASK_ENV=dev [envs] paketo-demofsd-app
```

`envs` needs to include values for each of:
ASSESSMENT_STORE_API_HOST
FUND_STORE_API_HOST
ACCOUNT_STORE_API_HOST
RSA256_PUBLIC_KEY_BASE64
AUTHENTICATOR_HOST
SENTRY_DSN
GITHUB_SHA

```
docker ps -a
CONTAINER ID   IMAGE                       COMMAND                  CREATED          STATUS                    PORTS                    NAMES
42633142c619   paketo-demofsd-app          "/cnb/process/web"       8 seconds ago    Up 7 seconds              0.0.0.0:8080->8080/tcp   peaceful_knuth
```

## Pipelines

These are the current pipelines running on the repo:

* Deploy to Gov PaaS - This is a simple pipeline to demonstrate capabilities.  Builds, tests and deploys a simple python application to the PaaS for evaluation in Dev and Test environments only.
* s3-zip - Tags every commit to main for release

## Copilot Initialisation

Copilot is the deployment of the infrastructure configuration, which is all stored under the copilot folder. The manifest files have been pre-generated by running through various initialisation steps that create the manifest files by prompting a series of questions, but do not _deploy_ the infrastructure.

For each AWS account, these commands will need to be run _once_ to initialise the environment:

`copilot app init pre-award` - this links the pre-award app with the current service, and associates the next commands with the service. Essentially, this provides context for the service to run under

```
    copilot init \
    --name fsd-assessment \
    --app pre-award \
    --type 'Load Balanced Web Service' \
    --image 'ghcr.io/communitiesuk/funding-service-design-assessment:latest' \
    --port 80
```

This will initalise this service, using the current created image
