{% extends "base.html" %}
{%- from "govuk_frontend_jinja/components/table/macro.html" import govukTable -%}
{%- from "govuk_frontend_jinja/components/textarea/macro.html" import govukTextarea -%}
{%- from "govuk_frontend_jinja/components/select/macro.html" import govukSelect -%}
{% from "macros/banner_summary.html" import banner_summary %}
{% set pageHeading = "Flag application" %}

{% block header %}
{% include "./components/header.html" %}
{% endblock header %}

{% block content %}
{% if form.errors.get("justification") or form.errors.get("section") %}
<div class="govuk-error-summary" data-module="govuk-error-summary">
    <div role="alert">
        <h2 class="govuk-error-summary__title">
            There is a problem
        </h2>
        <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
                {% if form.errors.get("justification") %}
                <li>
                    <a href=#{{ form.justification.id }}>{{ form.errors.get("justification") | join("\n") }}</a>
                </li>
                {% endif %}
                {% if form.errors.get("section") %}
                <li>
                    <a href=#{{ form.section.id }}>{{ form.errors.get("section") | join("\n") }}</a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>
{% endif %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <div>
            <div class="govuk-grid-column-two-thirds">
                <form method="post">
                    {{ form.csrf_token }}
                    <h1 class="govuk-heading govuk-heading-l">{{ pageHeading }}</h1>
                    <p class="govuk-body">
                        Flag a section to a lead assessor. They will review the responses
                        to either resolve your query, or stop the assessment.
                    </p>

                    {{ govukTextarea({
                        'id': form.justification.id,
                        'name': form.justification.id,
                        'label': {
                            'text': 'Reason for flagging',
                            'classes': 'govuk-label govuk-label--s'
                        },
                        'errorMessage': {
                            'text': form.errors.get("justification") | join("\n")
                        } if form.errors.get("justification") else None,
                        'rows': 8,
                        'value': form.justification.data or ""
                    }) }}

                    {# Get list of sub-sections from Assessor task list #}
                    {% set items = [] %}
                    {% set addFirstItem = items.append({'value': "",
                                                        'text': "Select section to flag",
                                                        'disabled': true,
                                                        'selected': true}) %}

                    {% for sub_section in state.get_sub_sections_metadata() %}
                        {% if sub_section["section_type"] == "Scored" %}
                            {# Get list of sub-sections from Scored section #}
                            {% set addItem = items.append({'value': sub_section["sub_section_id"],
                                                            'text': sub_section["sub_section_name"] + " (Scored - "+ sub_section["parent_section_name"] + ")",
                                                            'disabled': false}) %}
                        {% else %}
                            {# Get list of sub-sections from Unscored & Declaration sections #}
                            {% set addItem = items.append({'value': sub_section["sub_section_id"],
                                                            'text': sub_section["sub_section_name"] + " ("+ sub_section["parent_section_name"] + ")",
                                                            'disabled': false}) %}
                        {% endif %}
                    {% endfor %}

                    {{ govukSelect({
                        'id': form.section.id,
                        'name': form.section.id,
                        'items': items,
                        'label': {
                            'text': 'Section to flag',
                            'classes': 'govuk-label govuk-label--s'
                        },
                        'errorMessage': {
                            'text': form.errors.get("section") | join("\n"),
                        } if form.errors.get("section") else None,
                        'value': form.section.data or "",
                        'attributes': { 'data-qa': 'select_section_to_flag' }
                    })
                    }}

                    <div class="govuk-button-group">
                        <button class="govuk-button primary-button"
                                data-module="govuk-button">
                            Submit
                        </button>
                        <a href="{{ url_for('assess_bp.application', application_id=application_id)}}"
                            class="govuk-button secondary-button">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock content %}
