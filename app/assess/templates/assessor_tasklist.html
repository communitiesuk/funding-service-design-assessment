{% extends "base.html" %}
{%- from 'govuk_frontend_jinja/components/back-link/macro.html' import govukBackLink -%}
{%- from "govuk_frontend_jinja/components/table/macro.html" import govukTable -%}
{% from 'macros/section_element.html' import section_element -%}
{% from 'macros/criteria_element.html' import criteria_element -%}
{% from "macros/banner_summary.html" import banner_summary %}
{% from "macros/flag_application_button.html" import flag_application_button %}
{% from "macros/mark_qa_complete_button.html" import mark_qa_complete_button %}
{% from "macros/link_to_download_contract_docs.html" import link_to_download_contract_docs %}
{% from "macros/assessment_flag.html" import assessment_flagged %}
{% from "macros/assessment_flag.html" import assessment_stopped %}
{% from "macros/logout_partial.html" import logout_partial %}
{% from "macros/qa_complete_flag.html" import qa_complete_flag %}
{% from "macros/assessment_completion.html" import assessment_complete %}

{% set pageHeading = state.project_name %}

{% block header %}
<header role="banner" data-module="govuk-header">
    <nav class="govuk-width-container govuk-header__navigation">
        <div class="govuk-phase-banner flex-parent-element">
            <p class="govuk-!-text-align-left flex-parent-element flexed-element-margins-collapse">
                {{ govukBackLink({'href': url_for("assess_bp.fund_dashboard", fund_short_name=fund_short_name, round_short_name=round_short_name), 'html': 'Back to <b>assessment dashboard</b>', 'attributes': {'data-qa': 'back-to-assessment-dashboard'} }) }}
            </p>
            {{ logout_partial(sso_logout_url) }}
        </div>
    </nav>

    {{ banner_summary(
        state.fund_name,
        state.short_id,
        state.project_name,
        state.funding_amount_requested,
        display_status,
        g.user.highest_role,
        flag,
    ) }}
</header>
{% endblock header %}

{% block content %}

{% if flag and current_user_role in ["ASSESSOR", "LEAD_ASSESSOR"] and flag.is_qa_complete %}
    {{ qa_complete_flag(flag, flag_user_info, form.csrf_token, application_id, current_user_role) }}
{% endif %}

{% if flag and current_user_role in ("ASSESSOR", "LEAD_ASSESSOR") and flag.flag_type.name == "FLAGGED" %}
    {{ assessment_flagged(flag, flag_user_info, application_id, current_user_role) }}
{% elif flag and current_user_role in ("ASSESSOR", "LEAD_ASSESSOR") and display_status == "STOPPED" %}
    {{ assessment_stopped(flag, flag_user_info, application_id, current_user_role) }}
{% endif %}

{% if sub_criteria_status_completed and current_user_role != "COMMENTER" and not flag.is_qa_complete %}
{{ assessment_complete(state, flag, form.csrf_token, application_id, current_user_role )}}
{% endif %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
        <div class="govuk-grid-column-two-thirds">
            {% for section in state.sections %}
                {{ section_element(section.name, section.sub_criterias, application_id) }}
            {% endfor %}
            <h2 class="govuk-heading-l govuk-!-margin-top-8">Scored</h2>
            <p class="govuk-body">Assess all responses under each sub criteria.</p>
            {% for criteria in state.criterias %}
                {% set name_classes = "govuk-heading-m govuk-!-margin-bottom-2" %}
                {% if loop.index > 0 %}
                    {% set name_classes = "govuk-heading-m govuk-!-margin-bottom-2 govuk-!-margin-top-8" %}
                {% endif %}
                {{ criteria_element(criteria, name_classes, application_id) }}
            {% endfor %}
        </div>
        <div class="govuk-grid-column-one-third govuk-!-margin-top-2 govuk-button-group">
            <span>
                {% if g.user.highest_role == "LEAD_ASSESSOR" and state.workflow_status=="COMPLETED" and not flag.is_qa_complete and not (flag and (flag.flag_type.name == "STOPPED" or flag.flag_type.name == "FLAGGED" )) %}
                {{ mark_qa_complete_button(application_id) }}
                {% endif %}
            </span>
            <span>
                {% if is_flaggable and g.user.highest_role in ("ASSESSOR", "LEAD_ASSESSOR") %}
                {{ flag_application_button(application_id) }}
                {% endif %}
            </span>
        </div>
    </div>
</div>
{% endblock content %}
