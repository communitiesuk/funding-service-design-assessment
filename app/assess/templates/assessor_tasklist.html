{% extends "base.html" %}
{%- from 'govuk_frontend_jinja/components/back-link/macro.html' import govukBackLink -%}
{%- from "govuk_frontend_jinja/components/table/macro.html" import govukTable -%}
{% from 'macros/section_element.html' import section_element -%}
{% from 'macros/criteria_element.html' import criteria_element -%}
{% from "macros/banner_summary.html" import banner_summary %}
{% from "macros/flag_application_button.html" import flag_application_button %}
{% from "macros/mark_qa_complete_button.html" import mark_qa_complete_button %}
{% from "macros/assessment_flag.html" import assessment_flagged %}
{% from "macros/assessment_flag.html" import assessment_stopped %}
{% from "macros/logout_partial.html" import logout_partial %}
{% from "macros/qa_complete_flag.html" import qa_complete_flag %}


{% block content %}

<div class="govuk-phase-banner flex-parent-element">
    <p class="govuk-!-text-align-left flex-parent-element flexed-element-margins-collapse">
        <a href="{{url_for('assess_bp.landing')}}" class="govuk-back-link" id="back-to-assessment-dashboard">
            Back to <b>assessment dashboard</b></a>
    </p>

    {{ logout_partial(sso_logout_url) }}
</div>

    {% if flag and current_user_role in ("LEAD_ASSESSOR") and flag.is_qa_complete %}
    {{ qa_complete_flag(flag, flag_user_info) }}
    {% endif %}

    {% if flag and current_user_role in ("ASSESSOR", "LEAD_ASSESSOR") and flag.flag_type.name == "FLAGGED" %}
        {{ assessment_flagged(flag, flag_user_info, application_id, current_user_role) }}
    {% elif flag and current_user_role in ("ASSESSOR", "LEAD_ASSESSOR") and state.display_status == "STOPPED" %}
        {{ assessment_stopped(flag, flag_user_info, application_id, current_user_role) }}
    {% endif %}

    {% if state.workflow_status=="COMPLETED" and not flag.is_qa_complete %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <div class="assessment-complete  govuk-margin-bottom-8">
                    <h2 class="assessment-alert__heading govuk-heading-l govuk-!-margin-top-4">
                        Assessment complete</h2>
                    <p class="govuk-body">You have marked this assessment as complete.</p>
                    <p class="govuk-body">
                        It may now be selected for quality assurance (QA). New scores and rationales could be added if this
                        happens.
                    </p>
                </div>
            </div>
    {% elif sub_criteria_status_completed and not flag.is_qa_complete %}
    <form method="POST" action="{{ url_for('assess_bp.application', application_id=application_id) }}">
        {{ form.csrf_token }}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <div class="assessment-alert  govuk-margin-bottom-8">
                    <h2 class="assessment-alert__heading govuk-heading-l govuk-!-margin-top-4">All sections assessed</h2>
                    <p class="govuk-body">You can now mark the assessment as complete when you're ready.</p>
                    <p class="govuk-body">It may be selected for quality assurance (QA) once you've done this.</p>
                    <button class="govuk-button primary-button" data-module="govuk-button" type="submit">Mark as
                        complete</button>
                </div>
            </div>
        </div>
    </form>
    {% endif %}

    {{ banner_summary(
        state.fund_name,
        state.short_id,
        state.project_name,
        state.funding_amount_requested,
        state.display_status,
        flag
    ) }}

    <div class="govuk-width-container">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <div>
                    <div class="govuk-grid-column-two-thirds">
                        {% for section in state.sections %}
                            {{ section_element(section.name, section.sub_criterias, application_id) }}{% endfor %}
                        <h2 class="govuk-heading-l govuk-!-margin-top-8">Scored</h2>
                        <p class="govuk-body">Assess all responses under each sub criteria.</p>
                        {% for criteria in state.criterias %}
                            {% set name_classes = "govuk-heading-m govuk-!-margin-bottom-2" %}
                            {% if loop.index > 0 %}
                                {% set name_classes = "govuk-heading-m govuk-!-margin-bottom-2 govuk-!-margin-top-8" %}
                            {% endif %}
                            {{ criteria_element(criteria, name_classes, application_id) }}
                        {% endfor %}
                    </div>
                    <div class="govuk-grid-column-one-third govuk-!-margin-top-2 govuk-button-group">
                        <span>
                              {% if g.user.highest_role == "LEAD_ASSESSOR" and state.workflow_status=="COMPLETED" and not flag.is_qa_complete %}
                                {{ mark_qa_complete_button(application_id) }}
                              {% endif %}
                        </span>
                       <span>
                          {% if (not flag or state.flag_resolved or flag.flag_type.name == "QA_COMPLETED") and g.user.highest_role in ("ASSESSOR", "LEAD_ASSESSOR") %}
                            {{ flag_application_button(application_id) }}
                          {% endif %}
                        </span>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
