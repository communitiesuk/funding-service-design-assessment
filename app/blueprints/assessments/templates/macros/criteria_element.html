{%- from "govuk_frontend_jinja/components/table/macro.html" import govukTable -%}
{% macro criteria_element(criteria, name_classes, application_id, max_possible_sub_criteria_score) %}

    {% set rows = [] %}
    {% for sub_criteria in criteria.sub_criterias %}
        {%  set prev_subcriteria = criteria.sub_criterias[loop.index0 - 1] if not loop.first else None %}
        {%  set next_subcriteria = criteria.sub_criterias[loop.index0 + 1] if not loop.last else None %}
        {{ "\n" +" current" + sub_criteria.name }}
        {% if prev_subcriteria %}
            {{ " prev:" + prev_subcriteria.name }}
        {% endif %}
        {% if next_subcriteria %}
            {{ " next:"+ next_subcriteria.name }}
        {% endif %}
        {% set _ = rows.append([
            {
                "html": '<a class="govuk-link" data-qa="sub_criteria_name" href="{}">{}</a>'.format(
                    url_for(
                        'assessment_bp.display_sub_criteria',
                         application_id=application_id,
                         sub_criteria_id=sub_criteria.id
                    ),
                    sub_criteria.name
                )
            },
            { "text": sub_criteria.score if sub_criteria.score is not none or "", "format": "numeric" } if g.access_controller.has_any_assessor_role else None,
            { "html": '<span class="{}">{}</span>'.format('govuk-tag--scored-criteria' if sub_criteria.status == 'NOT_STARTED' else '', 'Complete' if sub_criteria.status=='COMPLETED' else sub_criteria.status|all_caps_to_human),
                "format": "numeric" }
        ]) %}
    {% endfor %}

    {% set _ = rows.append([
        { "html": "<strong>Total criteria score</strong>" },
        { "text": "" },
        { "text": "{} of {}".format(criteria.total_criteria_score, criteria.number_of_scored_sub_criteria * max_possible_sub_criteria_score), "format": "numeric" },
    ]) if g.access_controller.has_any_assessor_role %}

    <h3 class="{{ name_classes or '' }}">{{ criteria.name }}</h3>
    <p class="govuk-body govuk-!-margin-bottom-2">
        <strong>{{ (criteria.weighting * 100)|int }}%</strong> of overall score.
    </p>

    {{
        govukTable({
        "firstCellIsHeader":false,
        "head": [
            { "text": "Assessment sub criteria", "classes": "govuk-!-width-one-half"  },
            { "text": "Score out of {}".format(max_possible_sub_criteria_score), "format": "numeric" } if g.access_controller.has_any_assessor_role else None,
            { "text": "Status", "format": "numeric" }
        ],
        "rows": rows,
        "classes": "govuk-!-margin-bottom-6 govuk-table-no-bottom-border"
    }) }}

{% endmacro %}
